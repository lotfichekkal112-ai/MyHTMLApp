<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€” Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰</title>
<meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ù„ØªØªØ¨Ø¹ ÙØªØ­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù„Ø© - Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰. Ø¥Ø¶Ø§ÙØ© ØªÙ„Ø§Ù…ÙŠØ°ØŒ Ø·Ø¨Ø§Ø¹Ø©ØŒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØµÙˆØªÙŠØ©/Ù…Ø±Ø¦ÙŠØ©ØŒ Ù…ØµØ§Ø¯Ø± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¥Ø±Ø³Ø§Ù„ ØªÙ„ØºØ±Ø§Ù…." />
<style>
:root{
  --bg:#060607; --panel:#0b0c0f; --gold:#d4af37; --muted:#bdb8a6;
  --good:#27ae60; --warn:#f39c12; --bad:#e74c3c; --glass:rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,var(--bg),#040405);font-family:"Cairo","Segoe UI",Tahoma,system-ui,Arial;color:var(--gold);direction:rtl}
.container{max-width:1200px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:80px;height:80px;border-radius:12px;background:linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.04));display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--gold);font-size:34px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.title{font-size:20px;font-weight:900}
.subtitle{font-size:12px;color:var(--muted)}
.clock{font-weight:800;color:var(--gold);font-size:14px;text-align:left}
.card{background:linear-gradient(180deg,var(--panel),#081018);padding:12px;border-radius:12px;border:1px solid var(--glass);margin-top:12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
.btn{background:var(--gold);border:none;padding:10px 14px;border-radius:10px;font-weight:800;color:#000;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(212,175,55,0.08);color:var(--gold)}
.small{font-size:13px;color:var(--muted)}
.statusRow{display:flex;gap:12px;align-items:center}
.status{padding:12px;border-radius:10px;font-weight:900;font-size:16px;color:#fff;display:flex;justify-content:space-between;align-items:center;min-width:260px}
.status.red{background:linear-gradient(90deg,var(--bad),#8b101a)}
.status.yellow{background:linear-gradient(90deg,var(--warn),#b37a12);color:#000}
.status.green{background:linear-gradient(90deg,var(--good),#046f2a);color:#fff}
.progressWrap{flex:1;margin-left:8px}
.progressBar{height:18px;border-radius:10px;background:rgba(255,255,255,0.06);overflow:hidden;position:relative}
.progressFill{height:100%;width:0%;background:linear-gradient(90deg,var(--gold),#ffd55a);transition:width 1s ease,background-color 1s ease}
.dateBox{margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:800;color:var(--gold)}
.section{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
.left{flex:1;min-width:320px}
.right{width:420px;min-width:280px}
.input, textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:#071018;color:var(--gold);margin-top:8px}
.textarea-small{height:120px;resize:vertical}
.list{margin-top:10px;max-height:520px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
.personRow{display:flex;gap:8px;align-items:center;padding:12px;border-radius:10px;border-bottom:1px dashed rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(212,175,55,0.02), transparent)}
.personInfo{flex:1;text-align:right;max-width:calc(100% - 420px);overflow:hidden}
.personName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.personBirth{color:var(--muted);font-size:13px;margin-top:6px}
.rowActions{display:flex;gap:6px;flex-shrink:0;min-width:420px;justify-content:flex-start;direction:ltr}
.rowActions .btn{padding:8px 10px;font-size:13px;border-radius:8px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:9999;padding:12px}
.modal.open{display:flex}
.modal-card{width:100%;max-width:980px;background:#0b0b0f;border-radius:12px;padding:16px;border:1px solid rgba(212,175,55,0.06);color:var(--gold);text-align:right}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.full{grid-column:1/-1}
.copyBtn{background:transparent;border:1px solid rgba(212,175,55,0.08);padding:6px;border-radius:8px;color:var(--gold);cursor:pointer}
.printBtn{background:var(--gold);color:#000;border:none;padding:8px;border-radius:8px;cursor:pointer}
.footer{margin-top:14px;font-size:13px;color:var(--muted);display:flex;flex-direction:column;gap:6px;text-align:left}
.notif{position:fixed;bottom:16px;right:16px;background:var(--gold);color:#000;padding:10px 14px;border-radius:12px;display:none;font-weight:900;z-index:2000}
.smallMuted{color:var(--muted);font-size:12px}
.srcRow{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.srcRow input{flex:1}
.srcList{max-height:200px;overflow:auto;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:8px}
.toggle{display:inline-flex;align-items:center;gap:8px}
.switch{width:42px;height:24px;background:#333;border-radius:24px;position:relative;cursor:pointer}
.knob{position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right .18s ease}
.switch.on{background:linear-gradient(90deg,var(--good),#2ecc71)}
.switch.on .knob{right:21px}
.note{font-size:13px;color:var(--muted);margin-top:8px}
@media(max-width:900px){
  .rowActions{min-width:0;flex-wrap:wrap;justify-content:flex-end}
  .personInfo{max-width:100%}
  .right{width:100%}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">ğŸ“˜</div>
      <div>
        <div class="title">ØªØªØ¨Ø¹ ÙØªØ­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù„Ø© â€” Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰</div>
        <div class="subtitle">Company by Lotfi Chekkal</div>
      </div>
    </div>
    <div style="text-align:left">
      <div id="clock" class="clock">--:--:--</div>
      <div id="lastCheck" class="smallMuted">Ø¢Ø®Ø± ÙØ­Øµ: -</div>
    </div>
  </div>

  <div class="card">
    <div class="statusRow">
      <div id="statusBox" class="status red">ğŸ”´ Ø§Ù„Ø­Ø§Ù„Ø©: Ù„Ø§ Ø¯Ù„Ø§Ø¦Ù„</div>
      <div class="progressWrap">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="smallMuted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„</div>
          <div id="percentText" class="smallMuted">0%</div>
        </div>
        <div class="progressBar"><div id="progressFill" class="progressFill"></div></div>
      </div>
    </div>

    <div id="dateBox" class="dateBox">ğŸ“… ØªØ§Ø±ÙŠØ® Ù…Ø¤ÙƒØ¯ Ù„Ù„ÙØªØ­: <span id="confirmedDate" style="color:var(--muted)">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></div>

    <div class="controls">
      <button id="openAdd" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</button>
      <button id="tgBtn" class="btn ghost">ğŸ”” ØªÙØ¹ÙŠÙ„ ØªÙ„ØºØ±Ø§Ù…</button>
      <div style="flex:1"></div>
      <div class="toggle smallMuted">
        <div id="soundSwitch" class="switch"><div class="knob"></div></div>
        <div>ğŸ”Š ØµÙˆØª Ø§Ù„Ø§Ø´Ø¹Ø§Ø±Ø§Øª</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="left">
      <div class="card">
        <div style="font-weight:900">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ</div>
        <div class="smallMuted">Ø¹Ø±Ø¶: Ø±Ù‚Ù… ØªØ±ØªÙŠØ¨ â€” Ø§Ù„Ø§Ø³Ù… â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯. Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±.</div>
        <div id="list" class="list" aria-live="polite"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:900">Ø³Ø¬Ù„ Ù…Ø®ØªØµØ±</div>
        <div id="log" class="list" style="max-height:200px"></div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div style="font-weight:900">Ù…ØµØ§Ø¯Ø± â€” Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
        <div class="note">Ø£Ø¶Ù Ø±ÙˆØ§Ø¨Ø· ØµÙØ­Ø§Øª/Ù…ÙˆØ§Ù‚Ø¹ (ØµÙØ­Ø§Øª ÙÙŠØ³Ø¨ÙˆÙƒ Ø¹Ø§Ù…Ø©ØŒ Ø£Ø®Ø¨Ø§Ø± Ù…Ø­Ù„ÙŠØ©ØŒ Ù‚Ù†Ø§Ø© ÙŠÙˆØªÙŠÙˆØ¨ØŒ...) â€” Ø³ÙŠÙÙØ­Øµ ÙƒÙ„ Ù…ØµØ¯Ø± Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹.</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="newSource" placeholder="https://...">
          <button id="addSourceBtn" class="btn">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø±</button>
        </div>
        <div id="sourcesList" class="srcList"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="runCheck" class="btn">ğŸ” ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù†</button>
          <button id="clearLogs" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
      </div>

      <div class="card footer" style="margin-top:12px">
        <div>Developed by Lotfi Chekkal</div>
        <div class="smallMuted">Â© 2025 â€” ÙˆØ§Ø¬Ù‡Ø© Ø¯Ø§ÙƒÙ†Ø© Ù…Ø¹ Ø°Ù‡Ø¨ÙŠØ©</div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="modalAdd" class="modal"><div class="modal-card">
  <h3 id="addTitle">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h3>
  <div class="grid">
    <div><label>Ø§Ù„Ø§Ø³Ù… Ùˆ Ø§Ù„Ù„Ù‚Ø¨ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label><input id="f_nameAr" class="input"/></div>
    <div><label>Ø§Ù„Ø§Ø³Ù… Ùˆ Ø§Ù„Ù„Ù‚Ø¨ (Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©)</label><input id="f_nameFr" class="input"/></div>
    <div><label>ØªØ§Ø±ÙŠØ® ÙˆÙ…ÙƒØ§Ù† Ø§Ù„Ø§Ø²Ø¯ÙŠØ§Ø¯</label><input id="f_birth" class="input" placeholder="Ù…Ø«Ø§Ù„: 01/01/2005"/></div>
    <div><label>Ø±Ù‚Ù… Ø§Ù„ÙˆÙƒØ§Ù„Ø©</label><input id="f_agency" class="input"/></div>
    <div><label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ</label><input id="f_nid" class="input"/></div>
    <div><label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø§Ø±ÙŠ (CCP)</label><input id="f_ccp" class="input"/></div>
    <div class="full"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="f_phone" class="input"/></div>
    <div class="full" style="text-align:left">
      <button id="savePerson" class="btn">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="cancelAdd" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div></div>

<!-- Register / copy modal -->
<div id="modalInfo" class="modal"><div class="modal-card" id="modalInfoCard"></div></div>

<!-- Library modal (for printing) -->
<div id="libOverlay" class="modal"><div class="modal-card" id="libModalCard">
  <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h3>
  <div style="display:grid;grid-template-columns:1fr;gap:8px">
    <div><label>Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©</label><input id="lib-name" class="input" /></div>
    <div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="lib-address" class="input" /></div>
    <div style="display:flex;gap:8px"><div style="flex:1"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="lib-phone" class="input"/></div><div style="flex:1"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="lib-email" class="input"/></div></div>
  </div>
  <div style="text-align:left;margin-top:12px"><button id="libSave" class="btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</button><button id="libCancel" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button></div>
</div></div>

<div id="notif" class="notif"></div>

<script>
/* -------------------------
   Keys & storage helpers
   ------------------------- */
const KEY_PERSONS = 'batala_persons_v2';
const KEY_CFG = 'batala_cfg_v2';
const KEY_TG = 'batala_tg_v2';
const KEY_SOURCES = 'batala_sources_v2';
const KEY_SOUND = 'batala_sound_v2';

function readJSON(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}}
function writeJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* -------------------------
   UI helpers
   ------------------------- */
const $ = id => document.getElementById(id);
function showNotif(m,ms=3500){ const n=$('notif'); n.textContent=m; n.style.display='block'; setTimeout(()=> n.style.display='none', ms); }
function pushLog(m){ const cfg = readJSON(KEY_CFG, {}); cfg.logs = cfg.logs || []; cfg.logs.unshift({t: new Date().toISOString(), m}); cfg.logs = cfg.logs.slice(0,300); writeJSON(KEY_CFG, cfg); renderLog(); }

function renderLog(){ const cfg = readJSON(KEY_CFG, {}); const logs = cfg.logs || []; $('log').innerHTML = logs.map(x=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03)">${new Date(x.t).toLocaleString()} â€” ${x.m}</div>`).join('') }

/* -------------------------
   Clock
   ------------------------- */
function updateClock(){ $('clock').textContent = new Date().toLocaleTimeString('fr-FR'); }
setInterval(updateClock,1000); updateClock();

/* -------------------------
   Persons management
   ------------------------- */
let persons = readJSON(KEY_PERSONS, []);
let editingIndex = -1;

function renderList(filter=''){
  const list = $('list'); list.innerHTML='';
  const q = (filter||'').toLowerCase();
  persons.forEach((p,i)=>{
    const combined = ((p.nameAr||'')+' '+(p.birth||'')+' '+(p.nameFr||'')).toLowerCase();
    if(q && !combined.includes(q)) return;
    const row = document.createElement('div'); row.className='personRow';
    row.innerHTML = `<div class="personInfo"><div class="personName">#${i+1} â€” ${escapeHtml(p.nameAr)}</div><div class="personBirth">${escapeHtml(p.birth)}</div></div>
    <div class="rowActions">
      <button class="btn" title="ØªØ³Ø¬ÙŠÙ„" onclick="openRegister(${i})">ğŸŒ</button>
      <button class="btn" title="Ø·Ø¨Ø§Ø¹Ø©" onclick="startPrint(${i})">ğŸ–¨ï¸</button>
      <button class="btn ghost" title="ØªØ¹Ø¯ÙŠÙ„" onclick="editPerson(${i})">âœï¸</button>
      <button class="btn ghost" title="Ø­Ø°Ù" onclick="deletePerson(${i})">ğŸ—‘ï¸</button>
    </div>`;
    list.appendChild(row);
  });
}
function savePersons(){ writeJSON(KEY_PERSONS, persons); renderList(); }
function clearAddFields(){ ['f_nameAr','f_nameFr','f_birth','f_agency','f_nid','f_ccp','f_phone'].forEach(id=>$(id).value='') }

$('openAdd').onclick = ()=>{ editingIndex=-1; $('addTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ'; clearAddFields(); openModal('modalAdd'); }
$('cancelAdd').onclick = ()=>{ closeModal('modalAdd'); editingIndex=-1; }

$('savePerson').onclick = ()=>{
  const person = {
    id: editingIndex>=0 ? persons[editingIndex].id : Date.now().toString(36)+Math.random().toString(36).slice(2,8),
    nameAr: $('f_nameAr').value.trim(),
    nameFr: $('f_nameFr').value.trim(),
    birth: $('f_birth').value.trim(),
    agency: $('f_agency').value.trim(),
    nid: $('f_nid').value.trim(),
    ccp: $('f_ccp').value.trim(),
    phone: $('f_phone').value.trim(),
    created: new Date().toISOString()
  };
  if(!person.nameAr || !person.birth){ alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'); return; }
  if(editingIndex>=0){ persons[editingIndex]=person; pushLog('ØªØ¹Ø¯ÙŠÙ„: '+person.nameAr); } else { persons.unshift(person); pushLog('Ø¥Ø¶Ø§ÙØ©: '+person.nameAr); }
  savePersons(); closeModal('modalAdd');
}
function editPerson(i){ editingIndex=i; const p=persons[i]; $('addTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø´Ø®Øµ'; $('f_nameAr').value=p.nameAr; $('f_nameFr').value=p.nameFr; $('f_birth').value=p.birth; $('f_agency').value=p.agency; $('f_nid').value=p.nid; $('f_ccp').value=p.ccp; $('f_phone').value=p.phone; openModal('modalAdd'); }
function deletePerson(i){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ')){ pushLog('Ø­Ø°Ù: '+persons[i].nameAr); persons.splice(i,1); savePersons(); } }

/* -------------------------
   Modal helpers
   ------------------------- */
function openModal(id){ $(id).classList.add('open'); }
function closeModal(id){ $(id).classList.remove('open'); }

/* -------------------------
   Register modal & copying
   ------------------------- */
function openRegister(i){
  const p = persons[i];
  const card = $('modalInfoCard');
  card.innerHTML = `<h3>ØªØ³Ø¬ÙŠÙ„: ${escapeHtml(p.nameAr)}</h3><div style="text-align:right;line-height:1.6">
  <div>Ø§Ù„Ø§Ø³Ù… (Ø¹): ${escapeHtml(p.nameAr)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.nameAr)}')">Ù†Ø³Ø®</button></div>
  <div>Ø§Ù„Ø§Ø³Ù… (fr): ${escapeHtml(p.nameFr)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.nameFr)}')">Ù†Ø³Ø®</button></div>
  <div>ØªØ§Ø±ÙŠØ®/Ù…ÙƒØ§Ù†: ${escapeHtml(p.birth)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.birth)}')">Ù†Ø³Ø®</button></div>
  <div>Ø±Ù‚Ù… Ø§Ù„ÙˆÙƒØ§Ù„Ø©: ${escapeHtml(p.agency)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.agency)}')">Ù†Ø³Ø®</button></div>
  <div>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: ${escapeHtml(p.nid)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.nid)}')">Ù†Ø³Ø®</button></div>
  <div>CCP: ${escapeHtml(p.ccp)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.ccp)}')">Ù†Ø³Ø®</button></div>
  <div>Ø§Ù„Ù‡Ø§ØªÙ: ${escapeHtml(p.phone)} <button class="copyBtn" onclick="copyText('${escapeForJs(p.phone)}')">Ù†Ø³Ø®</button></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button class="btn" onclick="copyAll(${i})">Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    <button class="btn" onclick="openRegistrationSite()">ÙØªØ­ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button class="btn ghost" onclick="closeInfo()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div></div>`;
  $('modalInfo').classList.add('open');
  pushLog('Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„: '+p.nameAr);
}
function closeInfo(){ $('modalInfo').classList.remove('open'); }
function copyText(t){ navigator.clipboard.writeText(t).then(()=> showNotif('ØªÙ… Ø§Ù„Ù†Ø³Ø®')); }
function copyAll(i){ const p=persons[i]; const str=`${p.nameAr}\n${p.nameFr}\n${p.birth}\n${p.agency}\n${p.nid}\n${p.ccp}\n${p.phone}`; navigator.clipboard.writeText(str).then(()=> showNotif('ØªÙ… Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„')); }
function openRegistrationSite(){ window.open('https://minha.anem.dz/pre_inscription','_blank'); }

/* -------------------------
   Library print modal & classic print
   ------------------------- */
function ensureLibraryModal(){ /* lib overlay already in DOM */ }
function startPrint(i){
  ensureLibraryModal();
  const cfg = readJSON(KEY_CFG, {});
  $('lib-name').value = cfg.libName || 'Ù…ÙƒØªØ¨Ø© Ù†ÙˆØ± ØªØ¨Ø±ÙƒØ§Ù†ÙŠÙ†';
  $('lib-address').value = cfg.libAddress || '';
  $('lib-phone').value = cfg.libPhone || '';
  $('lib-email').value = cfg.libEmail || '';
  sessionStorage.setItem('__print_person_index', i.toString());
  $('libOverlay').classList.add('open');
  pushLog('ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø© Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø©');
}
$('libCancel').onclick = ()=>{ $('libOverlay').classList.remove('open'); }
$('libSave').onclick = confirmPrint;
function confirmPrint(){
  const name = $('lib-name').value.trim(); const addr=$('lib-address').value.trim(); const phone=$('lib-phone').value.trim(); const email=$('lib-email').value.trim();
  const cfg = readJSON(KEY_CFG, {}); cfg.libName = name; cfg.libAddress = addr; cfg.libPhone = phone; cfg.libEmail = email; writeJSON(KEY_CFG, cfg);
  const idx = parseInt(sessionStorage.getItem('__print_person_index'),10);
  if(isNaN(idx) || !persons[idx]){ showNotif('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø´Ø®Øµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  const p = persons[idx];
  const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>Ø·Ø¨Ø§Ø¹Ø© - ${escapeHtml(p.nameAr)}</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;direction:rtl;color:#000;padding:24px} h1{font-size:20px;margin:0 0 6px 0} .meta{margin-top:14px;font-size:16px} .meta b{display:inline-block;width:140px}</style></head><body>
  <div style="text-align:center"><h1>${escapeHtml(cfg.libName || 'Ù…ÙƒØªØ¨Ø©')}</h1><div>${escapeHtml(cfg.libAddress || '')}</div><div>${escapeHtml(cfg.libPhone || '')} â€” ${escapeHtml(cfg.libEmail || '')}</div></div>
  <hr>
  <h2 style="text-align:center;margin-top:18px">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ„Ù…ÙŠØ°</h2>
  <div class="meta"><div><b>Ø§Ù„Ø§Ø³Ù… (Ø¹):</b> ${escapeHtml(p.nameAr)}</div>
  <div><b>Ø§Ù„Ø§Ø³Ù… (fr):</b> ${escapeHtml(p.nameFr)}</div>
  <div><b>ØªØ§Ø±ÙŠØ®/Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø²Ø¯ÙŠØ§Ø¯:</b> ${escapeHtml(p.birth)}</div>
  <div><b>Ø±Ù‚Ù… Ø§Ù„ÙˆÙƒØ§Ù„Ø©:</b> ${escapeHtml(p.agency)}</div>
  <div><b>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ:</b> ${escapeHtml(p.nid)}</div>
  <div><b>CCP:</b> ${escapeHtml(p.ccp)}</div>
  <div><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${escapeHtml(p.phone)}</div></div>
  <footer style="margin-top:30px;font-size:12px">Developed by Lotfi Chekkal â€” ${new Date().toLocaleString()}</footer>
  </body></html>`;
  const w = window.open('','_blank','width=900,height=700'); w.document.write(html); w.document.close(); w.focus(); setTimeout(()=> w.print(), 500);
  $('libOverlay').classList.remove('open');
  pushLog('Ø·Ø¨Ø§Ø¹Ø©: '+p.nameAr);
}

/* -------------------------
   Sources management
   ------------------------- */
let sources = readJSON(KEY_SOURCES, []);
function renderSources(){
  const wrap = $('sourcesList');
  wrap.innerHTML = '';
  sources.forEach((s,i)=>{
    const div = document.createElement('div'); div.className='srcRow';
    div.innerHTML = `<input readonly value="${escapeHtml(s)}"><button class="btn ghost" onclick="removeSource(${i})">Ø­Ø°Ù</button>`;
    wrap.appendChild(div);
  });
  if(sources.length===0) wrap.innerHTML = '<div class="smallMuted">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ØµØ§Ø¯Ø± Ø¨Ø¹Ø¯.</div>';
}
$('addSourceBtn').addEventListener('click', ()=>{
  const v = $('newSource').value.trim();
  if(!v) return showNotif('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù…ØµØ¯Ø±');
  sources.unshift(v); writeJSON(KEY_SOURCES,sources); $('newSource').value=''; renderSources(); pushLog('Ø£Ø¶Ù Ù…ØµØ¯Ø±: '+v);
});
function removeSource(i){ if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±ØŸ')){ pushLog('Ø­Ø°Ù Ù…ØµØ¯Ø±: '+sources[i]); sources.splice(i,1); writeJSON(KEY_SOURCES,sources); renderSources(); }}

/* -------------------------
   Check engine
   ------------------------- */
const KEYWORDS = ['ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„','Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ÙØªÙˆØ­','Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„','Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„','inscription ouverte','dÃ©but inscription','pre_inscription','minha','Ø¨Ø·Ø§Ù„Ø©','ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù„Ø©','Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰','ain defla'];
const CORS = 'https://api.allorigins.win/raw?url='; // fallback proxy
async function fetchText(url){
  try{
    let res;
    try { res = await fetch(url, {cache:'no-store'}); if(res.ok) return await res.text(); } catch(e){}
    res = await fetch(CORS + encodeURIComponent(url), {cache:'no-store'});
    if(res.ok) return await res.text();
    return '';
  }catch(e){ return ''; }
}
function extractDateFromText(text){
  const p1 = /\b([0-3]?\d)[\/\-\.\s]([01]?\d)[\/\-\.\s](20\d{2})\b/g;
  let m;
  while((m=p1.exec(text))!==null){ return `${m[1]}/${m[2]}/${m[3]}`; }
  const p2 = /\b(20\d{2})[\/\-\.\s]?([01]?\d)[\/\-\.\s]?([0-3]?\d)\b/g;
  while((m=p2.exec(text))!==null){ return `${m[3]}/${m[2]}/${m[1]}`; }
  const monthsAr = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠ','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ†ÙŠØ©','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø§ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø§ÙƒØªÙˆØ¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
  const p3 = new RegExp(`\\b([0-3]?\\d)\\s*(${monthsAr.join('|')})(?:\\s*(20\\d{2}))?`,'i');
  m = p3.exec(text);
  if(m) return `${m[1]} ${m[2]} ${m[3]||''}`.trim();
  return null;
}

async function runCheck(allowNotify=true){
  const sList = sources.slice();
  if(sList.length===0){ showNotif('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± â€” Ø£Ø¶Ù Ù…ØµØ§Ø¯Ø± Ù„Ù„ÙØ­Øµ'); return; }
  $('lastCheck').textContent = new Date().toLocaleString();
  pushLog('Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ â€” '+sList.length+' Ù…ØµØ¯Ø±');
  let hits=0, total=sList.length, foundDates=[];
  for(const s of sList){
    try{
      const txt = await fetchText(s);
      if(!txt){ pushLog('Ù…ØµØ¯Ø± Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨: '+s); continue; }
      const low = txt.toLowerCase();
      const matched = KEYWORDS.some(k => low.includes(k));
      if(matched){ hits++; const d = extractDateFromText(txt); if(d) foundDates.push(d); pushLog('Ø¯Ù„Ø§Ø¦Ù„ Ù…Ù†: '+s); } else pushLog('Ù„Ø§ Ø¯Ù„Ø§Ø¦Ù„ Ù…Ù†: '+s);
    }catch(e){ pushLog('Ø®Ø·Ø£ ÙØ­Øµ: '+s); }
    await new Promise(r => setTimeout(r,200));
  }
  const percent = total? Math.round((hits/total)*100):0;
  updateProgress(percent);
  if(foundDates.length) {
    const freq = {}; foundDates.forEach(d=> freq[d] = (freq[d]||0)+1);
    const sorted = Object.keys(freq).sort((a,b)=> freq[b]-freq[a] || a.localeCompare(b));
    $('confirmedDate').textContent = sorted[0];
  } else $('confirmedDate').textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  if(percent>=90){ setStatus('green','ğŸŸ¢ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØªÙˆØ­ â€” Ø¯Ù„Ø§Ø¦Ù„ Ù‚ÙˆÙŠØ©'); if(allowNotify) notifyOpen($('confirmedDate').textContent); }
  else if(percent>=50) setStatus('yellow','ğŸŸ¡ Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¤ÙƒØ¯Ø© â€” Ø¯Ù„Ø§Ø¦Ù„ Ù…ØªÙˆØ³Ø·Ø©');
  else setStatus('red','ğŸ”´ Ù„Ø§ Ø¯Ù„Ø§Ø¦Ù„ ÙƒØ§ÙÙŠØ© â€” Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØºÙ„Ù‚ ØºØ§Ù„Ø¨Ø§Ù‹');
  pushLog('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙØ­Øµ â€” Ù†Ø³Ø¨Ø©: '+percent+'%');
}

function updateProgress(p){ $('progressFill').style.width = p+'%'; $('percentText').textContent = p+'%'; if(p>=90) $('progressFill').style.background='linear-gradient(90deg,var(--good),#6ef7a1)'; else if(p>=60) $('progressFill').style.background='linear-gradient(90deg,var(--warn),#ffd55a)'; else $('progressFill').style.background='linear-gradient(90deg,var(--gold),#ffd55a)'; }
function setStatus(c,t){ const b=$('statusBox'); b.classList.remove('red','yellow','green'); b.classList.add(c); b.textContent=t; }

/* start periodic check every 60s */
$('runCheck').addEventListener('click', ()=> runCheck(true));
setTimeout(()=> runCheck(false), 3000);
setInterval(()=> runCheck(false), 60*1000);

/* -------------------------
   Telegram integration
   ------------------------- */
$('tgBtn').addEventListener('click', ()=> {
  const cur = localStorage.getItem(KEY_TG) || '';
  const inpu = prompt('Ø£Ø¯Ø®Ù„ token|chatId (Ù…Ø«Ø§Ù„: 123456:ABCdef...|987654321)\nØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:', cur || '');
  if(inpu === null) return;
  if(inpu.trim()){ localStorage.setItem(KEY_TG, inpu.trim()); showNotif('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„ØºØ±Ø§Ù… Ù…Ø­Ù„ÙŠØ§Ù‹'); pushLog('Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ„ØºØ±Ø§Ù…'); } else { localStorage.removeItem(KEY_TG); showNotif('ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„ØºØ±Ø§Ù…'); }
});
function sendTelegram(msg){
  const val = localStorage.getItem(KEY_TG) || '';
  if(!val) return;
  const [token, chat] = val.split('|').map(x=>x.trim());
  if(!token||!chat) return;
  try{
    fetch(`https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:chat,text:msg})
    }).then(r=>{ if(r.ok) showNotif('Ø¥Ø´Ø¹Ø§Ø± ØªÙ„ØºØ±Ø§Ù… Ø£ÙØ±Ø³Ù„'); else showNotif('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ØªÙ„ØºØ±Ø§Ù…'); }).catch(()=> showNotif('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ØªÙ„ØºØ±Ø§Ù…'));
  }catch(e){ /* ignore */ }
}

/* -------------------------
   Notifications & sound
   ------------------------- */
function notifyOpen(date){
  const msg = `ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø­ØªÙ…Ù„${date && date!=='ØºÙŠØ± Ù…Ø­Ø¯Ø¯'? ' â€” ØªØ§Ø±ÙŠØ®: '+date : ''}`;
  try{
    if("Notification" in window){
      if(Notification.permission==='granted') new Notification(msg);
      else if(Notification.permission!=='denied') Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(msg); });
    }
  }catch(e){}
  sendTelegram(msg);
  showNotif(msg,7000);
  if(readJSON(KEY_SOUND,true)) playNotifyTone();
}

/* WebAudio tones */
let audioCtx = null;
function ensureAudio(){ if(audioCtx) return audioCtx; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }
function playNotifyTone(){ try{ const ctx = ensureAudio(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0; o.connect(g); g.connect(ctx.destination); const now = ctx.currentTime; g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.12, now+0.02); o.start(now); o.frequency.exponentialRampToValueAtTime(1320, now+0.25); g.gain.exponentialRampToValueAtTime(0.0001, now+0.7); setTimeout(()=> o.stop(),900);}catch(e){}}
function playEntranceTone(){ try{ const ctx = ensureAudio(); const o1 = ctx.createOscillator(), o2 = ctx.createOscillator(); const g = ctx.createGain(); g.gain.value=0; o1.type='sine'; o1.frequency.value=220; o2.type='sine'; o2.frequency.value=440; o1.connect(g); o2.connect(g); g.connect(ctx.destination); const now = ctx.currentTime; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.18, now+0.12); o1.start(now); o2.start(now+0.03); o1.frequency.exponentialRampToValueAtTime(660, now+0.8); o2.frequency.exponentialRampToValueAtTime(1320, now+0.8); g.gain.exponentialRampToValueAtTime(0.0001, now+1.2); setTimeout(()=>{ try{o1.stop(); o2.stop();}catch(e){} },1400);}catch(e){}}

/* sound switch UI */
function setSoundUI(on){ const sw = $('soundSwitch'); if(on) sw.classList.add('on'); else sw.classList.remove('on'); writeJSON(KEY_SOUND, !!on); }
$('soundSwitch').addEventListener('click', ()=>{ const on = !$('soundSwitch').classList.contains('on'); setSoundUI(on); showNotif(on? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª':'ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØµÙˆØª'); });
setSoundUI(readJSON(KEY_SOUND,true));
window.addEventListener('load', ()=>{ setTimeout(()=>{ try{ playEntranceTone(); }catch(e){} }, 300); });

/* -------------------------
   Utilities
   ------------------------- */
function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeForJs(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,'\\n'); }

/* -------------------------
   Initial render & persistence
   ------------------------- */
renderList();
renderSources();
renderLog();
window.addEventListener('beforeunload', ()=>{ writeJSON(KEY_PERSONS, persons); writeJSON(KEY_SOURCES, sources); });

/* -------------------------
   Buttons: clear logs
   ------------------------- */
$('clearLogs').addEventListener('click', ()=>{ if(confirm('Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«ØŸ')){ const cfg = readJSON(KEY_CFG,{}); cfg.logs = []; writeJSON(KEY_CFG,cfg); renderLog(); showNotif('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„'); } });

/* expose some functions globally used by inline handlers */
window.openRegister = openRegister;
window.startPrint = startPrint;
window.editPerson = editPerson;
window.deletePerson = deletePerson;
window.copyText = copyText;
window.copyAll = copyAll;

/* -------------------------
   register site helper that keeps modal open
   ------------------------- */
function registerSite(i){
  openRegister(i);
  window.open('https://minha.anem.dz/pre_inscription','_blank');
}
window.registerSite = registerSite;

/* -------------------------
   Load default example sources if empty
   ------------------------- */
if(sources.length===0){
  sources = [
    'https://www.mtess.gov.dz',
    'https://www.aps.dz',
    'https://www.elkhabar.com',
    'https://news.google.com/search?q=Ø¹ÙŠÙ†+Ø§Ù„Ø¯ÙÙ„Ù‰+ØªØ³Ø¬ÙŠÙ„+Ø§Ù„Ø¨Ø·Ø§Ù„Ø©'
  ];
  writeJSON(KEY_SOURCES,sources);
  renderSources();
}

/* -------------------------
   allow clicking outside modals to close
   ------------------------- */
document.addEventListener('click', (e)=>{
  document.querySelectorAll('.modal.open').forEach(m=>{
    if(m===e.target) m.classList.remove('open');
  });
});

/* -------------------------
   Utility: manual runCheck exposure
   ------------------------- */
window.runCheck = runCheck;

/* End script */
</script>
</body>
</html>
```î¨0î¨‚